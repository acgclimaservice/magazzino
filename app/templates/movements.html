<!-- Sostituisci app/templates/movements.html con questo: -->
{% extends "_base.html" %}
{% block title %}Movimenti{% endblock %}
{% block content %}
<div class="bg-white p-4 rounded-xl shadow">
  <h1 class="text-xl font-semibold mb-4">Movimenti Magazzino</h1>
  
  <!-- Form per movimento manuale -->
  <div class="mb-6 p-4 bg-gray-50 rounded-lg">
    <h2 class="text-lg font-semibold mb-3">Nuovo Movimento Manuale</h2>
    <form method="post" class="grid md:grid-cols-5 gap-3">
      <div>
        <label class="block text-xs text-gray-600 mb-1">Codice Articolo</label>
        <input name="codice_articolo" class="w-full border rounded px-2 py-1 text-sm" required>
      </div>
      <div>
        <label class="block text-xs text-gray-600 mb-1">Quantit√†</label>
        <input name="quantita" type="number" step="0.001" class="w-full border rounded px-2 py-1 text-sm" required>
      </div>
      <div>
        <label class="block text-xs text-gray-600 mb-1">Tipo</label>
        <select name="tipo" class="w-full border rounded px-2 py-1 text-sm" onchange="toggleMagazzinoFields(this.value)">
          <option value="carico">Carico</option>
          <option value="scarico">Scarico</option>
          <option value="trasferimento">Trasferimento</option>
        </select>
      </div>
      <div id="magazzino-single">
        <label class="block text-xs text-gray-600 mb-1">Magazzino</label>
        <select name="magazzino" class="w-full border rounded px-2 py-1 text-sm">
          {% for m in magazzini %}
            <option value="{{ m.id }}">{{ m.codice }} - {{ m.nome }}</option>
          {% endfor %}
        </select>
      </div>
      <div id="magazzino-from" class="hidden">
        <label class="block text-xs text-gray-600 mb-1">Da Magazzino</label>
        <select name="magazzino_from" class="w-full border rounded px-2 py-1 text-sm">
          {% for m in magazzini %}
            <option value="{{ m.id }}">{{ m.codice }} - {{ m.nome }}</option>
          {% endfor %}
        </select>
      </div>
      <div id="magazzino-to" class="hidden">
        <label class="block text-xs text-gray-600 mb-1">A Magazzino</label>
        <select name="magazzino_to" class="w-full border rounded px-2 py-1 text-sm">
          {% for m in magazzini %}
            <option value="{{ m.id }}">{{ m.codice }} - {{ m.nome }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="flex items-end">
        <button type="submit" class="w-full px-3 py-2 bg-emerald-600 text-white rounded text-sm">
          ‚ûï Registra
        </button>
      </div>
    </form>
  </div>

  <!-- Tabella movimenti -->
  <div class="overflow-x-auto">
    <table class="w-full text-sm border">
      <thead class="bg-gray-100">
        <tr>
          <th class="p-2 text-left">Data</th>
          <th class="p-2 text-left">Articolo</th>
          <th class="p-2 text-center">Tipo</th>
          <th class="p-2 text-right">Quantit√†</th>
          <th class="p-2 text-left">Da</th>
          <th class="p-2 text-left">A</th>
          <th class="p-2 text-left">Documento</th>
        </tr>
      </thead>
      <tbody>
        {% for m in movimenti.items %}
        <tr class="border-t hover:bg-gray-50">
          <td class="p-2">
            <time datetime="{{ m.data }}">{{ m.data.strftime('%d/%m/%Y %H:%M') if m.data else '' }}</time>
          </td>
          <td class="p-2">
            <div class="font-mono text-xs text-gray-500">{{ m.articolo.codice_interno if m.articolo else '' }}</div>
            <div class="text-sm">{{ m.articolo.descrizione if m.articolo else '' }}</div>
          </td>
          <td class="p-2 text-center">
            {% if m.tipo == 'carico' %}
              <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">üìà Carico</span>
            {% elif m.tipo == 'scarico' %}
              <span class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs">üìâ Scarico</span>
            {% elif m.tipo == 'trasferimento' %}
              <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">üîÑ Trasf.</span>
            {% else %}
              <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-xs">{{ m.tipo }}</span>
            {% endif %}
          </td>
          <td class="p-2 text-right font-semibold">
            {% if m.tipo == 'scarico' %}
              <span class="text-red-600">-{{ m.quantita }}</span>
            {% else %}
              <span class="text-green-600">+{{ m.quantita }}</span>
            {% endif %}
          </td>
          <td class="p-2">
            <span class="text-sm">{{ labels_da[m.id] or '‚Äî' }}</span>
          </td>
          <td class="p-2">
            <span class="text-sm">{{ labels_a[m.id] or '‚Äî' }}</span>
          </td>
          <td class="p-2">
            {% if m.documento_id %}
              <a href="{{ url_for('documents.document_detail', id=m.documento_id) }}" 
                 class="text-blue-600 hover:underline text-xs">
                DOC #{{ m.documento_id }}
              </a>
            {% else %}
              <span class="text-gray-400 text-xs">Manuale</span>
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr>
          <td class="p-4 text-center text-gray-500" colspan="7">Nessun movimento registrato.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Paginazione -->
  {% if movimenti.pages > 1 %}
  <div class="mt-4 flex items-center gap-2 text-sm">
    <span>Pagina {{ movimenti.page }} di {{ movimenti.pages }}</span>
    <div class="ml-auto flex gap-2">
      {% if movimenti.has_prev %}
        <a class="px-3 py-1 rounded border" href="{{ url_for('movements.movements', page=movimenti.prev_num) }}">‚Üê Precedente</a>
      {% endif %}
      {% if movimenti.has_next %}
        <a class="px-3 py-1 rounded border" href="{{ url_for('movements.movements', page=movimenti.next_num) }}">Successiva ‚Üí</a>
      {% endif %}
    </div>
  </div>
  {% endif %}
</div>

<script>
function toggleMagazzinoFields(tipo) {
  const single = document.getElementById('magazzino-single');
  const from = document.getElementById('magazzino-from');
  const to = document.getElementById('magazzino-to');
  
  if (tipo === 'trasferimento') {
    single.classList.add('hidden');
    from.classList.remove('hidden');
    to.classList.remove('hidden');
  } else {
    single.classList.remove('hidden');
    from.classList.add('hidden');
    to.classList.add('hidden');
  }
}
</script>
{% endblock %}
