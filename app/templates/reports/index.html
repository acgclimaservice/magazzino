<!-- Crea file: app/templates/reports/index.html -->
{% extends "_base.html" %}
{% block title %}Report{% endblock %}
{% block content %}
<div class="bg-white p-6 rounded-xl shadow">
  <h1 class="text-xl font-semibold mb-6">üìä Report e Analisi</h1>
  
  <div class="grid md:grid-cols-2 gap-4">
    <a href="{{ url_for('reports.report_mastrini') }}" 
       class="block p-6 border rounded-xl hover:shadow-lg transition">
      <div class="flex items-center mb-3">
        <span class="text-2xl mr-3">üìà</span>
        <h2 class="text-lg font-semibold">Report Mastrini</h2>
      </div>
      <p class="text-gray-600 text-sm">
        Riepilogo per mastrini acquisti e vendite con totali e margini
      </p>
    </a>
    
    <a href="{{ url_for('reports.report_movimenti_periodo') }}" 
       class="block p-6 border rounded-xl hover:shadow-lg transition opacity-50">
      <div class="flex items-center mb-3">
        <span class="text-2xl mr-3">üì¶</span>
        <h2 class="text-lg font-semibold">Movimenti per Periodo</h2>
      </div>
      <p class="text-gray-600 text-sm">
        Analisi movimenti magazzino per periodo (Coming soon)
      </p>
    </a>
  </div>
</div>
{% endblock %}

<!-- ======================================= -->
<!-- Crea file: app/templates/reports/mastrini.html -->
{% extends "_base.html" %}
{% block title %}Report Mastrini{% endblock %}
{% block content %}
<div class="bg-white p-6 rounded-xl shadow">
  <div class="flex items-center justify-between mb-6">
    <h1 class="text-xl font-semibold">üìà Report Mastrini</h1>
    <a href="{{ url_for('reports.reports_index') }}" 
       class="text-blue-600 hover:underline text-sm">‚Üê Torna ai Report</a>
  </div>
  
  <!-- FILTRI -->
  <div class="mb-6 p-4 bg-gray-50 rounded-lg">
    <form method="get" class="grid md:grid-cols-4 gap-3">
      <div>
        <label class="block text-xs text-gray-600 mb-1">Data Dal</label>
        <input type="date" name="date_from" value="{{ filters.date_from or '' }}" 
               class="w-full border rounded px-2 py-1 text-sm">
      </div>
      <div>
        <label class="block text-xs text-gray-600 mb-1">Data Al</label>
        <input type="date" name="date_to" value="{{ filters.date_to or '' }}" 
               class="w-full border rounded px-2 py-1 text-sm">
      </div>
      <div>
        <label class="block text-xs text-gray-600 mb-1">Tipo Mastrino</label>
        <select name="tipo" class="w-full border rounded px-2 py-1 text-sm">
          <option value="">Tutti</option>
          <option value="ACQUISTO" {% if filters.tipo == 'ACQUISTO' %}selected{% endif %}>Solo Acquisti</option>
          <option value="RICAVO" {% if filters.tipo == 'RICAVO' %}selected{% endif %}>Solo Ricavi</option>
        </select>
      </div>
      <div class="flex items-end gap-2">
        <button type="submit" class="px-3 py-1 bg-indigo-600 text-white rounded text-sm">
          üîç Filtra
        </button>
        <a href="{{ url_for('reports.report_mastrini') }}" 
           class="px-3 py-1 bg-gray-300 text-gray-700 rounded text-sm">Reset</a>
      </div>
    </form>
  </div>
  
  <!-- TOTALI GENERALI -->
  <div class="grid md:grid-cols-4 gap-4 mb-6">
    <div class="bg-red-50 p-4 rounded-lg">
      <div class="text-red-600 text-sm font-semibold">Totale Acquisti</div>
      <div class="text-xl font-bold text-red-700">‚Ç¨ {{ "%.2f"|format(totale_acquisti) }}</div>
    </div>
    <div class="bg-green-50 p-4 rounded-lg">
      <div class="text-green-600 text-sm font-semibold">Totale Vendite</div>
      <div class="text-xl font-bold text-green-700">‚Ç¨ {{ "%.2f"|format(totale_vendite) }}</div>
    </div>
    <div class="bg-blue-50 p-4 rounded-lg">
      <div class="text-blue-600 text-sm font-semibold">Margine Totale</div>
      <div class="text-xl font-bold {{ 'text-green-700' if margine_totale >= 0 else 'text-red-700' }}">
        ‚Ç¨ {{ "%.2f"|format(margine_totale) }}
      </div>
    </div>
    <div class="bg-gray-50 p-4 rounded-lg">
      <div class="text-gray-600 text-sm font-semibold">Margine %</div>
      <div class="text-xl font-bold text-gray-700">
        {% if totale_vendite > 0 %}
          {{ "%.1f"|format((margine_totale / totale_vendite) * 100) }}%
        {% else %}
          0%
        {% endif %}
      </div>
    </div>
  </div>
  
  <!-- TABELLA DETTAGLIO -->
  <div class="overflow-x-auto">
    <table class="w-full text-sm border">
      <thead class="bg-gray-100">
        <tr>
          <th class="p-3 text-left">Codice Mastrino</th>
          <th class="p-3 text-left">Descrizione</th>
          <th class="p-3 text-center">Tipo</th>
          <th class="p-3 text-center">N¬∞ Operazioni</th>
          <th class="p-3 text-right">Totale Acquisti</th>
          <th class="p-3 text-right">Totale Vendite</th>
          <th class="p-3 text-right">Margine</th>
          <th class="p-3 text-right">Margine %</th>
        </tr>
      </thead>
      <tbody>
        {% for row in results %}
        {% set margine_riga = (row.totale_vendite or 0) - (row.totale_acquisti or 0) %}
        <tr class="border-t hover:bg-gray-50">
          <td class="p-3 font-mono text-xs">{{ row.mastrino_codice }}</td>
          <td class="p-3">{{ row.mastrino_descrizione or row.mastrino_codice }}</td>
          <td class="p-3 text-center">
            {% if row.mastrino_tipo == 'ACQUISTO' %}
              <span class="bg-red-100 text-red-800 px-2 py-1 rounded text-xs">ACQUISTO</span>
            {% elif row.mastrino_tipo == 'RICAVO' %}
              <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-xs">RICAVO</span>
            {% else %}
              <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded text-xs">N/D</span>
            {% endif %}
          </td>
          <td class="p-3 text-center">{{ row.num_righe }}</td>
          <td class="p-3 text-right text-red-700 font-semibold">
            {% if row.totale_acquisti %}‚Ç¨ {{ "%.2f"|format(row.totale_acquisti) }}{% else %}‚Äî{% endif %}
          </td>
          <td class="p-3 text-right text-green-700 font-semibold">
            {% if row.totale_vendite %}‚Ç¨ {{ "%.2f"|format(row.totale_vendite) }}{% else %}‚Äî{% endif %}
          </td>
          <td class="p-3 text-right font-semibold {{ 'text-green-700' if margine_riga >= 0 else 'text-red-700' }}">
            ‚Ç¨ {{ "%.2f"|format(margine_riga) }}
          </td>
          <td class="p-3 text-right">
            {% if row.totale_vendite and row.totale_vendite > 0 %}
              {{ "%.1f"|format((margine_riga / row.totale_vendite) * 100) }}%
            {% else %}
              ‚Äî
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr>
          <td class="p-4 text-center text-gray-500" colspan="8">
            Nessun dato trovato per i filtri selezionati.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  
  <div class="mt-4 text-xs text-gray-500">
    üí° Questo report include solo documenti confermati con mastrini assegnati.
  </div>
</div>
{% endblock %}
