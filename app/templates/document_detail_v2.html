{% extends "_base.html" %}
{% block title %}Dettaglio Documento{% endblock %}

{% block content %}
<div class="bg-white p-4 rounded-xl shadow">
  <!-- Intestazione e Pulsanti -->
  <div class="flex items-center justify-between">
    <div>
      <div class="text-lg font-semibold" id="doc-title">Caricamento...</div>
      <div class="text-sm text-gray-600">Stato: <span id="doc-status" class="font-medium">...</span></div>
    </div>
    <div id="actions-bar" class="flex gap-2">
      <a class="px-3 py-2 rounded bg-gray-100 text-gray-800 text-sm" href="{{ url_for('documents.documents_in') }}">Torna all'archivio</a>
    </div>
  </div>

  <hr class="my-4"/>

  <!-- Dati Intestazione -->
  <div id="doc-header" class="grid md:grid-cols-3 gap-2 text-sm text-gray-700 mb-4"></div>

  <!-- Allegati -->
  <div id="allegati-container" class="mb-4"></div>

  <!-- Righe del Documento -->
  <div id="righe-container">
    <div class="text-sm text-gray-500">Caricamento righe…</div>
  </div>

  <!-- Form Aggiungi Riga (visibile solo in bozza) -->
  <div id="add-line-form-container" class="hidden mt-6 pt-4 border-t">
    <h3 class="font-semibold mb-2">Aggiungi Articolo</h3>
    <div class="p-2 border rounded-md bg-gray-50 mb-4">
        <label class="block text-xs text-gray-600">Cerca articolo esistente per pre-compilare i campi</label>
        <div class="relative">
          <input id="add-line-search" type="text" class="border rounded p-2 w-full text-sm" placeholder="Cerca per codice o descrizione...">
          <div id="search-dropdown" class="absolute z-10 w-full bg-white border rounded mt-1 shadow-lg max-h-60 overflow-y-auto" style="display: none;"></div>
        </div>
    </div>
    <form id="add-line-form" class="space-y-3">
        <input id="add-line-articolo-id" type="hidden">
        <div class="grid md:grid-cols-3 gap-3">
            <div class="md:col-span-1">
                <label class="block text-xs text-gray-600">Codice Interno (lascia vuoto per auto-generazione)</label>
                <input id="add-line-cod-int" type="text" class="border rounded p-2 w-full text-sm">
            </div>
            <div class="md:col-span-1">
                <label class="block text-xs text-gray-600">Codice Fornitore</label>
                <input id="add-line-cod-forn" type="text" class="border rounded p-2 w-full text-sm">
            </div>
            <div class="md:col-span-1">
                <label class="block text-xs text-gray-600">Mastrino</label>
                <select id="add-line-mastrino" class="border rounded p-2 w-full text-sm"></select>
            </div>
        </div>
        <div>
            <label class="block text-xs text-gray-600">Descrizione</label>
            <input id="add-line-desc" type="text" class="border rounded p-2 w-full text-sm" required>
        </div>
        <div class="grid md:grid-cols-3 gap-3">
            <div>
                <label class="block text-xs text-gray-600">Quantità</label>
                <input id="add-line-qty" type="number" step="0.001" class="border rounded p-2 w-full text-sm" value="1" required>
            </div>
            <div>
                <label class="block text-xs text-gray-600">UM</label>
                <input id="add-line-um" type="text" class="border rounded p-2 w-full text-sm" value="PZ">
            </div>
            <div>
                <label class="block text-xs text-gray-600">Prezzo Unitario</label>
                <input id="add-line-price" type="number" step="0.01" class="border rounded p-2 w-full text-sm" value="0">
            </div>
        </div>
        <div class="text-right">
            <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white text-sm">Aggiungi Riga</button>
        </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  var docId = {{ doc.id }};
  var docData = null;
  var documentsUrl = "{{ url_for('documents.documents_in') }}";

  var actionsBar = document.getElementById('actions-bar');
  var docTitle = document.getElementById('doc-title');
  var docStatus = document.getElementById('doc-status');
  var docHeader = document.getElementById('doc-header');
  var righeContainer = document.getElementById('righe-container');
  var allegatiContainer = document.getElementById('allegati-container');
  var addLineFormContainer = document.getElementById('add-line-form-container');
  var addLineForm = document.getElementById('add-line-form');

  // --- FUNZIONI DI RENDER ---
  function render() {
    if (!docData) return;
    docTitle.textContent = 'Documento ' + docData.tipo + (docData.numero ? ' n. ' + docData.numero + '/' + docData.anno : ' (Bozza)');
    docStatus.textContent = docData.status;
    renderActions();
    var dataDoc = docData.data ? new Date(docData.data).toLocaleDateString('it-IT') : 'Non assegnata';
    docHeader.innerHTML = '<div><span class="text-gray-500">Controparte:</span> ' + (docData.partner_nome || 'N/D') + '</div>' +
                          '<div><span class="text-gray-500">Magazzino:</span> ' + (docData.magazzino_info || 'N/D') + '</div>' +
                          '<div><span class="text-gray-500">Data Documento:</span> ' + dataDoc + '</div>';
    renderAllegati();
    renderRighe();
    addLineFormContainer.classList.toggle('hidden', docData.status !== 'Bozza');
  }

  function renderActions() {
    actionsBar.innerHTML = '';
    if (docData.status === 'Bozza') {
      actionsBar.innerHTML += '<button id="btn-delete-draft" class="px-3 py-2 rounded bg-red-600 text-white text-sm">Elimina Bozza</button>' +
                              '<button id="btn-confirm" class="px-3 py-2 rounded bg-emerald-600 text-white text-sm">Conferma DDT</button>';
    } else if (docData.status === 'Confermato') {
       actionsBar.innerHTML += '<a class="px-3 py-2 rounded bg-indigo-600 text-white text-sm" href="/files/export-document/' + docId + '.pdf">Esporta PDF</a>';
    }
    actionsBar.innerHTML += '<a class="px-3 py-2 rounded bg-gray-100 text-gray-800 text-sm" href="' + documentsUrl + '">Torna all\'archivio</a>';
    bindActionEvents();
  }

  function renderAllegati() {
    var allegati = docData.allegati || [];
    if (!allegati.length) { allegatiContainer.innerHTML = ''; return; }
    var html = '<h3 class="font-semibold text-sm mb-2">Allegati</h3><div class="flex flex-col gap-1">';
    allegati.forEach(function(a) {
      html += '<a href="' + a.url + '" target="_blank" class="text-sm text-blue-600 hover:underline inline-flex items-center">' +
              '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 11-2 0V4H6v12a1 1 0 11-2 0V4zm5 8a1 1 0 011-1h2a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>' +
              a.filename + '</a>';
    });
    html += '</div>';
    allegatiContainer.innerHTML = html;
  }

  function renderRighe() {
    var rows = docData.righe || [];
    if (!rows.length) { righeContainer.innerHTML = '<div class="text-sm text-gray-500 p-4 text-center">Nessuna riga in questo documento.</div>'; return; }
    var html = '<div class="overflow-x-auto"><table class="w-full text-sm">' +
          '<thead class="bg-gray-100"><tr>' +
              '<th class="p-2 text-left">Cod. Interno</th><th class="p-2 text-left">Cod. Fornitore</th>' +
              '<th class="p-2 text-left">Descrizione</th><th class="p-2 text-right">Q.tà</th>' +
              '<th class="p-2 text-right">Prezzo</th><th class="p-2 text-left">Mastrino</th>' +
              (docData.status === 'Bozza' ? '<th class="p-2"></th>' : '') +
            '</tr></thead><tbody>';
    rows.forEach(function(r) {
      html += '<tr class="border-t hover:bg-gray-50" data-line-id="' + r.id + '">' +
          '<td class="p-2 font-mono text-xs">' + (r.codice_interno || '') + '</td>' +
          '<td class="p-2 font-mono text-xs">' + (r.codice_fornitore || '') + '</td>' +
          '<td class="p-2">' + (r.descrizione || '') + '</td>' +
          '<td class="p-2 text-right">' + (r.quantita || 0).toFixed(3) + '</td>' +
          '<td class="p-2 text-right">' + (r.prezzo || 0).toFixed(2) + ' €</td>' +
          '<td class="p-2">' + (r.mastrino_codice || '') + '</td>' +
          (docData.status === 'Bozza' ? '<td class="p-2 text-right"><button class="btn-delete-line text-red-500 hover:underline text-xs" data-line-id="' + r.id + '">Elimina</button></td>' : '') +
        '</tr>';
    });
    html += '</tbody></table></div>';
    righeContainer.innerHTML = html;
    bindLineEvents();
  }

  // --- LOGICA API ---
  function apiCall(url, options) {
    options = options || {};
    return fetch(url, options).then(function(res) {
        return res.json().then(function(data) {
            if (!res.ok || !data.ok) { throw new Error(data.error || 'Errore HTTP ' + res.status); }
            return data;
        });
    }).catch(function(e) {
        alert('Errore di comunicazione: ' + e.message);
        throw e;
    });
  }
  
  function loadData() { return apiCall('/api/documents/' + docId + '/json').then(function(data) { docData = data.doc; render(); }); }

  // --- BINDING EVENTI ---
  function bindActionEvents() {
    var btnConfirm = document.getElementById('btn-confirm');
    if (btnConfirm) { btnConfirm.addEventListener('click', function() { if (confirm('Confermare DDT? L\'operazione è irreversibile.')) { apiCall('/api/documents/' + docId + '/confirm', { method: 'POST' }).then(loadData); } }); }
    var btnDeleteDraft = document.getElementById('btn-delete-draft');
    if (btnDeleteDraft) { btnDeleteDraft.addEventListener('click', function() { if (confirm('Eliminare questa bozza?')) { apiCall('/api/documents/' + docId + '/delete-draft', { method: 'POST' }).then(function() { window.location.href = documentsUrl; }); } }); }
  }

  function bindLineEvents() {
    document.querySelectorAll('.btn-delete-line').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        var lineId = e.target.dataset.lineId;
        if (confirm('Eliminare questa riga?')) { apiCall('/api/documents/lines/' + lineId + '/delete', { method: 'POST' }).then(loadData); }
      });
    });
  }

  addLineForm.addEventListener('submit', function(e) {
    e.preventDefault();
    var payload = {
        articolo_id: document.getElementById('add-line-articolo-id').value || null,
        codice_interno: document.getElementById('add-line-cod-int').value,
        codice_fornitore: document.getElementById('add-line-cod-forn').value,
        descrizione: document.getElementById('add-line-desc').value,
        quantita: document.getElementById('add-line-qty').value,
        um: document.getElementById('add-line-um').value,
        prezzo: document.getElementById('add-line-price').value,
        mastrino_codice: document.getElementById('add-line-mastrino').value
    };
    apiCall('/api/documents/' + docId + '/add-line', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
    .then(function() {
      addLineForm.reset();
      document.getElementById('add-line-articolo-id').value = '';
      loadData();
    });
  });

  // --- AUTOCOMPLETE CORRETTO CON DROPDOWN ---
  var searchInput = document.getElementById('add-line-search');
  var searchDropdown = document.getElementById('search-dropdown');
  var searchTimer;

  searchInput.addEventListener('input', function() {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(function() {
          var query = searchInput.value;
          console.log('🔍 Ricerca corretta:', query);
          
          if (query.length < 2) {
              searchDropdown.style.display = 'none';
              return;
          }
          
          searchDropdown.innerHTML = '<div style="padding: 10px; color: #666;">Ricerca in corso...</div>';
          searchDropdown.style.display = 'block';
          
          // ENDPOINT CORRETTO + DROPDOWN
          var magId = docData && docData.magazzino_id ? docData.magazzino_id : 1;
          var url = '/api/inventory/search?q=' + encodeURIComponent(query) + '&magazzino_id=' + magId;
          
          fetch(url)
              .then(function(response) { return response.json(); })
              .then(function(results) {
                  console.log('📦 Risultati trovati:', results);
                  searchDropdown.innerHTML = '';
                  
                  if (!results || results.length === 0) {
                      searchDropdown.innerHTML = '<div style="padding: 10px; color: #999;">Nessun articolo trovato.</div>';
                      return;
                  }
                  
                  results.forEach(function(art) {
                      var item = document.createElement('div');
                      item.style.cssText = 'padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s;';
                      item.innerHTML = 
                          '<div style="font-weight: bold; color: #333;">' + (art.codice_interno || art.codice_fornitore || 'N/A') + ' - ' + (art.descrizione || 'N/A') + '</div>' +
                          '<div style="font-size: 12px; color: #666;">Giacenza: ' + (art.giacenza || 0) + ' | Ultimo costo: ' + ((art.last_cost || 0).toFixed(2)) + ' €</div>';
                      
                      item.onmouseover = function() { this.style.backgroundColor = '#f3f4f6'; };
                      item.onmouseout = function() { this.style.backgroundColor = ''; };
                      
                      item.onclick = function() {
                          console.log('🎯 Articolo selezionato:', art);
                          
                          // PRE-COMPILA I CAMPI CON DATI CORRETTI
                          document.getElementById('add-line-articolo-id').value = art.articolo_id || art.id;
                          document.getElementById('add-line-cod-int').value = art.codice_interno || '';
                          document.getElementById('add-line-cod-forn').value = art.codice_fornitore || '';
                          document.getElementById('add-line-desc').value = art.descrizione || '';
                          document.getElementById('add-line-price').value = (art.last_cost || 0).toFixed(2);
                          
                          // PULISCI E CHIUDI
                          searchInput.value = '';
                          searchDropdown.style.display = 'none';
                          
                          console.log('✅ Campi pre-compilati!');
                      };
                      
                      searchDropdown.appendChild(item);
                  });
              })
              .catch(function(err) {
                  console.error('❌ Errore ricerca:', err);
                  searchDropdown.innerHTML = '<div style="padding: 10px; color: #dc2626;">Errore di ricerca</div>';
              });
      }, 300);
  });

  // Chiudi dropdown quando clicchi fuori
  document.addEventListener('click', function(e) {
      if (!searchInput.contains(e.target) && !searchDropdown.contains(e.target)) {
          searchDropdown.style.display = 'none';
      }
  });

  function loadMastrini() {
      var tipoMastrino = (docData && docData.tipo === 'DDT_OUT') ? 'RICAVO' : 'ACQUISTO';
      apiCall('/api/mastrini?tipo=' + tipoMastrino).then(function(response) {
          var sel = document.getElementById('add-line-mastrino');
          sel.innerHTML = '';
          if (response.data && Array.isArray(response.data)) {
              response.data.forEach(function(m) {
                  var opt = document.createElement('option');
                  opt.value = m.codice;
                  opt.textContent = m.codice + ' - ' + m.descrizione;
                  sel.appendChild(opt);
              });
          }
      });
  }

  // --- Inizializzazione ---
  loadData().then(loadMastrini);

})();
</script>
{% endblock %}
